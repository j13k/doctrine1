Update from 1.0 to 1.1
======================

This document details the changes made to Doctrine 1.1 to make it easier for you to upgrade your projects to use this version.

Doctrine Record
---------------

[r5014](http://trac.doctrine-project.org/changeset/5014) - Added support for `FROM User u WHERE u.id IN ?` in the Doctrine_Query api.

    $q = Doctrine_Query::create()
      ->from('User u')
      ->where('u.id IN ?', array(1, 2, 3));
    $users = $q->execute();

[r5019](http://trac.doctrine-project.org/changeset/5019) - `unlink()` and `link()` have been changed to not delete references until `save()` is called on the object. Also, fixed synchronizeWithArray() to synchronize many to many relationships.

    // Does not link until save()
    $user = Doctrine::getTable('User')->find(1);
    $user->link('Groups', array(1, 2, 3));
    $user->save();

    // Third argument will force it to save instantly
    $user = Doctrine::getTable('User')->find(1);
    $user->link('Groups', array(1, 2, 3), true);

    $user = Doctrine::getTable('User')->find(1);
    $userArray = array(
        'Group' => array(
            '_identifiers' => array(
                1 => true,
                2 => true,
                3 => false)
        ));

    $user->synchronizeWithArray($userArray);
    $user->save();

[r5034](http://trac.doctrine-project.org/changeset/5034) - You can now retrieve the old values of records through the getModified() function. By default it returns an array of fieldName => newValue but if you specify getModified(true) it will return the old values.

    $users = Doctrine::getTable('User')->findAll();
    $user = $users->getFirst();
    $user->name = 'zYne-';
    
    $oldValues = $user->getModified(true);
    /*
    array(
      'name' => 'zYne',
    )
    */
    
    $newValues = $user->getModified(false);
    /*
    array(
      'name' => 'zYne-',
    )
    */

Default Options
---------------

[r5027](http://trac.doctrine-project.org/changeset/5039) - Added support for setting default charset and collate for tables.

Set globally on a Doctrine_Manager instance.

    $manager->setCollate('utf8_unicode_ci');
    $manager->setCharset('utf8');

The same can be set on the Doctrine_Connection and Doctrine_Record levels.

    $connection->setCollate('utf8_unicode_ci');
    $connection->setCharset('utf8');

    public function setTableDefinition()
    {
      $this->setCollate('utf8_unicode_ci');
      $this->setCharset('utf8');
    }

[r5030](http://trac.doctrine-project.org/changeset/5039) - Added support for setting default options for columns and auto added identifier columns.

The following is now possible on Doctrine_Manager, Doctrine_Connection and Doctrine_Record.

    $manager->setAttribute(Doctrine::ATTR_DEFAULT_COLUMN_OPTIONS, array('type' => 'string', 'length' => 255, 'notnull' => true));

You can also customize the values that make up the auto added identifier column as well.

    $manager->setAttribute(Doctrine::ATTR_DEFAULT_IDENTIFIER_OPTIONS, array('name' => '%s_id', 'type' => 'string', 'length' => 16)); // %s in the name is replaced with the table name.

Doctrine Query
--------------

A query can now be transformed from an update() or delete() to a select() or any combination. Run a query once to update a field then turn it to a select and execute it.

    $q = Doctrine_Query::create()
        ->update('User u')
        ->set('u.password', '?', 'newpassword')
        ->where('u.username = ?', 'jwage');
    $q->execute();

    // Change it to a select query
    $q->select();
    $user = $q->fetchOne();

[r5018](http://trac.doctrine-project.org/changeset/5018) - Added `Doctrine::ATTR_AUTO_FREE_QUERY_OBJECTS` for auto freeing query objects after execution 

    $manager->setAttribute('auto_free_query_objects');
    $q = Doctrine_Query::create()
      ->from('User u')
    $users = $q->execute(); // $q->free() is triggered

Doctrine Collection
-------------------

[r5032](http://trac.doctrine-project.org/changeset/5032) - You can now convert a Doctrine_Collection in to a key value array made up of the values from the two specified columns.

    $q = Doctrine_Query::create()
        ->from('User u');
    $users = $q->execute();

    $array = $users->toKeyValueArray('id', 'name');
    print_r($array);

    /*
    array(
      4 => 'zYne',
      5 => 'Arnold Schwarzenegger',
      6 => 'Michael Caine',
      7 => 'Takeshi Kitano',
      8 => 'Sylvester Stallone',
      9 => 'Kurt Russell',
      10 => 'Jean Reno',
      11 => 'Edward Furlong',
    )
    */

Doctrine Validation
-------------------

[r5033](http://trac.doctrine-project.org/changeset/5033) - You can now specify a unique validator on a set of fields. The argument of the unique() function can either be an array of fields or an argument for each field.

    public function setTableDefinition()
    {
        $this->hasColumn('username', 'string', 255);
        $this->hasColumn('email_address', 'string', 255);

        $this->unique('username', 'email_address');
    }